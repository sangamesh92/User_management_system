trigger:
  branches:
    include:
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  javaVersion: '21'
  artifactName: 'drop'

stages:

# =====================================================
# BUILD STAGE
# =====================================================
- stage: Build
  displayName: "Build Spring Boot Application"
  jobs:
  - job: BuildJob
    displayName: "Gradle Build"
    steps:

    # Install Java
    - task: JavaToolInstaller@0
      displayName: "Install Java 21"
      inputs:
        versionSpec: $(javaVersion)
        jdkArchitectureOption: x64
        jdkSourceOption: PreInstalled

    # Grant execute permission to Gradle wrapper
    - script: chmod +x gradlew
      displayName: 'Grant execute permission to Gradle wrapper'

    # Gradle Build
    - task: Gradle@3
      displayName: "Gradle Build"
      inputs:
        gradleWrapperFile: 'gradlew'
        tasks: 'clean build'
        publishJUnitResults: false

    # Copy JAR
    - task: CopyFiles@2
      displayName: "Copy JAR to staging"
      inputs:
        SourceFolder: '$(System.DefaultWorkingDirectory)/build/libs'
        Contents: '*.jar'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    # Publish Artifact
    - task: PublishBuildArtifacts@1
      displayName: "Publish Artifact"
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: $(artifactName)

# =====================================================
# DEPLOY STAGE
# =====================================================
- stage: Deploy
  displayName: "Deploy to Azure App Service"
  dependsOn: Build
  condition: succeeded()

  jobs:
  - job: DeployJob
    displayName: "Azure App Service Deployment"
    steps:

    # Download Artifact
    - task: DownloadPipelineArtifact@2
      displayName: "Download Artifact"
      inputs:
        artifact: $(artifactName)
        path: '$(System.ArtifactsDirectory)'

    # Deploy to Azure App Service
    - task: AzureWebApp@1
      displayName: "Deploy Spring Boot App"
      inputs:
        azureSubscription: 'secret-santa'
        appType: 'webAppLinux'
        appName: 'secretsantavault'
        package: '$(System.ArtifactsDirectory)/hg-christmas-0.0.1-SNAPSHOT.jar'
        runtimeStack: 'JAVA|21-java21'
